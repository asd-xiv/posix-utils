#!/usr/bin/env sh

# Symlink aware script paths and name
REAL_PATH=$(realpath "$0")
SCRIPT_DIR=$(dirname "$REAL_PATH")
SCRIPT_NAME=$(basename "$REAL_PATH")

# Config vars for `$SCRIPT_DIR/log.sh`
export LOG_NAMESPACE=" $SCRIPT_NAME"
# export LOG_LEVEL="${LOG_LEVEL:-info}"

# ╭───┤ Bootstrap & Argument parsing
# ╰─

_log() {
  "$SCRIPT_DIR/pu-log" "$@"
}

_color() {
  "$SCRIPT_DIR/pu-color" "$@"
}

show_help() {
  cat <<EOF
$(_color gray "USAGE:")
  $SCRIPT_NAME <COMMAND> [OPTIONS...]

$(_color gray "VERSION:")
  @VERSION

$(_color gray "COMMANDS:")
  log              Print formatted log messages with timestamps and colors
  tadaa            Display celebratory messages with decorative borders
  git-has-changed  Check if files changed since a git commit
  install          Install packages across different systems and package managers
  color            Print colored text to terminal
  npm-bundle       Create distributable package bundle for deployment

$(_color gray "OPTIONS:")
  -h, --help       Show detailed man page
  -v, --version    Show version information

$(_color gray "EXAMPLES:")
  $SCRIPT_NAME log info "Build started"
  $SCRIPT_NAME tadaa "Deploy completed"
  $SCRIPT_NAME git-has-changed package.json --since HEAD~1
  $SCRIPT_NAME install git curl jq
  $SCRIPT_NAME npm-bundle --include .env

For detailed help on any command, use: $SCRIPT_NAME <COMMAND> --help
EOF
}

# ╭───┤ Main. Start Here.
# ╰─

AVAILABLE_COMMANDS="log tadaa git-has-changed install color npm-bundle"
COMMAND=$1
shift

if [ -z "$COMMAND" ]; then
  _log error -v available_commands "$AVAILABLE_COMMANDS" \
    "No command provided"
  exit 1
fi

if [ "$COMMAND" = "-h" ] || [ "$COMMAND" = "--help" ] || [ "$COMMAND" = "--hlep" ]; then
  show_help
  exit 0
fi

if [ "$COMMAND" = "-v" ] || [ "$COMMAND" = "--version" ]; then
  echo "@VERSION"
  exit 0
fi

for cmd in $AVAILABLE_COMMANDS; do
  if [ "$cmd" = "$COMMAND" ]; then
    exec "$SCRIPT_DIR/pu-$COMMAND" "$@"
  fi
done

_log error -v command "$COMMAND" \
  -v available_commands "$AVAILABLE_COMMANDS" \
  "Unsupported command"

exit 1
